# Backend CI/CD Pipeline
# Build ‚Üí Lint ‚Üí Test ‚Üí Deploy to Staging ‚Üí Manual Approval ‚Üí Deploy to Production

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - api/**
      - azure-pipelines-backend.yml
    exclude:
      - README.md
      - docs/*
      - '*.md'

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - api/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.11'
  azureSubscription: 'Shop-Smart-Service' # Azure DevOps service connection name
  backendAppServiceStaging: 'shopsmart-backend-staging' # Update with your staging App Service name
  backendAppServiceProduction: 'shopsmart-backend-production' # Update with your production App Service name
  buildArtifact: 'backend-drop'
  # ACR settings (update acrName/acrLoginServer if different)
  acrName: 'shopsmartacr'
  acrLoginServer: 'shopsmartacr.azurecr.io'
  backendImageRepository: 'shopsmart-backend'

  # Variable groups (create these in Azure DevOps)
  # - 'Backend-Secrets' (contains: SQL_CONNECTION_STRING, APPINSIGHTS_INSTRUMENTATIONKEY, etc.)

stages:
  # STAGE 1: BUILD
  - stage: Build
    displayName: 'Build Backend'
    jobs:
      - job: BuildJob
        displayName: 'Build and Package Backend'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              echo "Installing dependencies..."
              cd api
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install Dependencies'

          - script: |
              echo "Preparing build artifact..."
              cd api
              mkdir -p $(Build.ArtifactStagingDirectory)/app

              # Copy application files
              cp -r app/ $(Build.ArtifactStagingDirectory)/app/
              cp -r alembic/ $(Build.ArtifactStagingDirectory)/app/ 2>/dev/null || true
              cp requirements.txt $(Build.ArtifactStagingDirectory)/app/
              cp alembic.ini $(Build.ArtifactStagingDirectory)/app/ 2>/dev/null || true
              cp run.py $(Build.ArtifactStagingDirectory)/app/ 2>/dev/null || true

              echo "Build artifact prepared successfully"
              ls -la $(Build.ArtifactStagingDirectory)/app/
            displayName: 'Prepare Build Artifact'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: '$(buildArtifact)'
              publishLocation: 'Container'
            displayName: 'Publish Build Artifact'

  # STAGE 2: LINT
  - stage: Lint
    displayName: 'Code Quality & Linting'
    dependsOn: Build
    jobs:
      - job: LintJob
        displayName: 'Run Code Quality Checks'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              echo "Installing linting tools..."
              pip install flake8 black
            displayName: 'Install Linting Tools'

          - script: |
              echo "Running Flake8..."
              cd api
              flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics --max-line-length=100 --extend-ignore=E203,W503 || true
              flake8 app/ --count --exit-zero --max-line-length=100 --extend-ignore=E203,W503 --statistics
            displayName: 'üîç Run Flake8 Linter'
            continueOnError: true

          - script: |
              echo "Checking code formatting with Black..."
              cd api
              black --check app/ --exclude='venv|__pycache__|.git' || echo "‚ö†Ô∏è Code formatting issues found. Run 'black .' locally to fix."
            displayName: 'Check Code Formatting (Black)'
            continueOnError: true

  # STAGE 3: TEST
  - stage: Test
    displayName: 'Testing Stage'
    dependsOn: Lint
    jobs:
      - job: UnitTests
        displayName: 'Run Backend Tests'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              echo "Installing dependencies and test tools..."
              cd api
              pip install -r requirements.txt
              pip install pytest pytest-cov pytest-asyncio pytest-azurepipelines httpx
            displayName: 'Install Test Dependencies'

          - script: |
              echo "Running tests with coverage..."
              cd api
              pytest tests/ -v --junitxml=test-results.xml --cov=app --cov-report=xml --cov-report=html --cov-report=term --cov-fail-under=60
            displayName: 'Run Tests with Coverage'
            continueOnError: false
            env:
              SQL_CONNECTION_STRING: 'sqlite:///:memory:'
              APP_ENV: 'test'

          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results.xml'
              failTaskOnFailedTests: true
              testRunTitle: 'Backend Unit Tests'
            displayName: 'Publish Test Results'
            condition: always()

          - task: PublishCodeCoverageResults@1
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/api/coverage.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/api/htmlcov'
            displayName: 'Publish Code Coverage'
            condition: always()

  # STAGE 4: DEPLOY STAGING
  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: Test
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployStaging
        displayName: 'Deploy Backend to Staging'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                # Build & push Docker image to ACR
                - task: AzureCLI@2
                  displayName: 'Build and Push Backend Image to ACR'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      set -e
                      echo "Logging in to ACR..."
                      az acr login --name $(acrName)

                      IMAGE_TAG="$(acrLoginServer)/$(backendImageRepository):$(Build.BuildId)"
                      echo "Building image: $IMAGE_TAG"

                      cd api
                      docker build -t "$IMAGE_TAG" .

                      echo "Pushing image to ACR..."
                      docker push "$IMAGE_TAG"

                      echo "##vso[task.setvariable variable=backendImageTag;isOutput=true]$IMAGE_TAG"
                # Configure App Service to use container from ACR
                - task: AzureWebApp@1
                  displayName: 'üöÄ Deploy Container to Staging'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webAppContainer'
                    appName: '$(backendAppServiceStaging)'
                    imageName: '$(acrLoginServer)/$(backendImageRepository):$(Build.BuildId)'

                # Smoke test after deployment
                - script: |
                    echo "Running smoke test..."
                    sleep 10  # Wait for app to start
                    BACKEND_URL="https://$(backendAppServiceStaging).azurewebsites.net"
                    response=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/health" || echo "000")
                    if [ "$response" = "200" ]; then
                      echo "‚úÖ Smoke test passed: /health returned 200"
                      curl -s "$BACKEND_URL/health" | head -20
                    else
                      echo "‚ùå Smoke test failed: /health returned $response"
                      exit 1
                    fi
                  displayName: 'üß™ Run Smoke Test (/health)'
                  continueOnError: false

                - script: |
                    echo "Deployment completed successfully!"
                    echo "Staging URL: https://$(backendAppServiceStaging).azurewebsites.net"
                    echo "Health Check: https://$(backendAppServiceStaging).azurewebsites.net/health"
                    echo "API Docs: https://$(backendAppServiceStaging).azurewebsites.net/docs"
                  displayName: 'Deployment Summary'

  # STAGE 5: DEPLOY PRODUCTION (Manual Approval Required)
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: DeployStaging
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployProduction
        displayName: 'Deploy Backend to Production'
        environment: 'production'  # Configure manual approval in Azure DevOps
        strategy:
          runOnce:
            deploy:
              steps:
                # Use same image tag that was pushed for this build
                - task: AzureWebApp@1
                  displayName: 'üöÄ Deploy Container to Production'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webAppContainer'
                    appName: '$(backendAppServiceProduction)'
                    imageName: '$(acrLoginServer)/$(backendImageRepository):$(Build.BuildId)'

                - script: |
                    echo "Running smoke test..."
                    sleep 10
                    BACKEND_URL="https://$(backendAppServiceProduction).azurewebsites.net"
                    response=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/health" || echo "000")
                    if [ "$response" = "200" ]; then
                      echo "‚úÖ Smoke test passed: /health returned 200"
                    else
                      echo "‚ùå Smoke test failed: /health returned $response"
                      exit 1
                    fi
                  displayName: 'üß™ Run Smoke Test (/health)'

                - script: |
                    echo "Production deployment completed!"
                    echo "Production URL: https://$(backendAppServiceProduction).azurewebsites.net"
                  displayName: 'Deployment Summary'
