# Frontend CI/CD Pipeline
# Build ‚Üí Lint ‚Üí Deploy to Staging ‚Üí Manual Approval ‚Üí Deploy to Production

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - frontend/**
      - azure-pipelines-frontend.yml
    exclude:
      - README.md
      - docs/*
      - '*.md'

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - frontend/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '18.x'
  azureSubscription: 'Shop-Smart-Service' # Azure DevOps service connection name
  frontendStaticWebAppName: 'shopsmart-frontend' # Update if using Static Web App
  frontendAppServiceStaging: 'shopsmart-frontend-staging' # Update if using App Service
  frontendAppServiceProduction: 'shopsmart-frontend-production' # Update if using App Service
  buildArtifact: 'frontend-drop'
  # ACR settings (update acrName/acrLoginServer if different)
  acrName: 'shopsmartacr'
  acrLoginServer: 'shopsmartacr.azurecr.io'
  frontendImageRepository: 'shopsmart-frontend'

  # Variable groups (create these in Azure DevOps)
  # - 'Frontend-Config' (contains: VITE_API_BASE for staging/production)

stages:
  # STAGE 1: BUILD
  - stage: Build
    displayName: 'Build Frontend'
    jobs:
      - job: BuildJob
        displayName: 'Build React App'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Use Node.js $(nodeVersion)'

          - script: |
              echo "Installing dependencies..."
              cd frontend
              npm ci
            displayName: 'Install Dependencies'

          - script: |
              echo "Building React app..."
              cd frontend
              # Set API base URL for build (use variable group in production)
              export VITE_API_BASE=$(VITE_API_BASE_STAGING)
              npm run build
            displayName: 'Build React App'
            env:
              VITE_API_BASE: 'https://shopsmart-backend-staging.azurewebsites.net/api/v1' # Update with your backend URL

          - script: |
              echo "Verifying build output..."
              cd frontend
              if [ -d "dist" ] && [ -f "dist/index.html" ]; then
                echo "‚úÖ Build successful"
                ls -la dist/
                echo "--- index.html preview ---"
                head -20 dist/index.html
              else
                echo "‚ùå Build failed: dist/index.html not found"
                exit 1
              fi
            displayName: 'Verify Build Output'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/frontend/dist'
              ArtifactName: '$(buildArtifact)'
              publishLocation: 'Container'
            displayName: 'Publish Build Artifact'

  # STAGE 2: LINT
  - stage: Lint
    displayName: 'Code Quality & Linting'
    dependsOn: Build
    jobs:
      - job: LintJob
        displayName: 'Run ESLint'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Use Node.js $(nodeVersion)'

          - script: |
              echo "Installing ESLint..."
              cd frontend
              npm ci
              # Install ESLint if not in package.json
              if ! grep -q "eslint" package.json; then
                npm install --save-dev eslint @eslint/js
              fi
            displayName: 'Install ESLint'

          - script: |
              echo "Running ESLint..."
              cd frontend
              if [ -f "node_modules/.bin/eslint" ]; then
                npx eslint src/ --ext .js,.jsx --format compact || echo "‚ö†Ô∏è ESLint issues found"
              else
                echo "‚ö†Ô∏è ESLint not configured, skipping..."
              fi
            displayName: 'üîç Run ESLint'
            continueOnError: true

  # STAGE 3: DEPLOY STAGING
  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: Lint
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployStaging
        displayName: 'Deploy Frontend to Staging'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                # Build & push Docker image to ACR
                - task: AzureCLI@2
                  displayName: 'Build and Push Frontend Image to ACR'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      set -e
                      echo "Logging in to ACR..."
                      az acr login --name $(acrName)

                      IMAGE_TAG="$(acrLoginServer)/$(frontendImageRepository):$(Build.BuildId)"
                      echo "Building image: $IMAGE_TAG"

                      cd frontend
                      docker build \
                        --build-arg VITE_API_BASE="$(VITE_API_BASE_STAGING)" \
                        -t "$IMAGE_TAG" .

                      echo "Pushing image to ACR..."
                      docker push "$IMAGE_TAG"

                      echo "##vso[task.setvariable variable=frontendImageTag;isOutput=true]$IMAGE_TAG"

                # Configure App Service to use container from ACR
                - task: AzureWebApp@1
                  displayName: 'üöÄ Deploy Container to App Service (Staging)'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webAppContainer'
                    appName: '$(frontendAppServiceStaging)'
                    imageName: '$(acrLoginServer)/$(frontendImageRepository):$(Build.BuildId)'

                # Validate deployment
                - script: |
                    echo "Validating deployment..."
                    sleep 5
                    FRONTEND_URL="https://$(frontendAppServiceStaging).azurewebsites.net"
                    response=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" || echo "000")
                    if [ "$response" = "200" ]; then
                      echo "‚úÖ Frontend loads successfully"
                      # Check if index.html contains expected content
                      html=$(curl -s "$FRONTEND_URL" || echo "")
                      if echo "$html" | grep -q "root"; then
                        echo "‚úÖ index.html structure valid"
                      else
                        echo "‚ö†Ô∏è index.html may be incomplete"
                      fi
                    else
                      echo "‚ùå Frontend validation failed: HTTP $response"
                      exit 1
                    fi
                  displayName: 'üß™ Validate Frontend Deployment'
                  continueOnError: false

                - script: |
                    echo "Staging deployment completed!"
                    echo "Frontend URL: https://$(frontendAppServiceStaging).azurewebsites.net"
                  displayName: 'Deployment Summary'

  # STAGE 4: DEPLOY PRODUCTION (Manual Approval Required)
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: DeployStaging
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployProduction
        displayName: 'Deploy Frontend to Production'
        environment: 'production'  # Configure manual approval in Azure DevOps
        strategy:
          runOnce:
            deploy:
              steps:
                # Build & push production image to ACR
                - task: AzureCLI@2
                  displayName: 'Build and Push Frontend Production Image to ACR'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      set -e
                      echo "Logging in to ACR..."
                      az acr login --name $(acrName)

                      IMAGE_TAG="$(acrLoginServer)/$(frontendImageRepository):$(Build.BuildId)-prod"
                      echo "Building production image: $IMAGE_TAG"

                      cd frontend
                      docker build \
                        --build-arg VITE_API_BASE="$(VITE_API_BASE_PRODUCTION)" \
                        -t "$IMAGE_TAG" .

                      echo "Pushing image to ACR..."
                      docker push "$IMAGE_TAG"

                      echo "##vso[task.setvariable variable=frontendProdImageTag;isOutput=true]$IMAGE_TAG"

                - task: AzureWebApp@1
                  displayName: 'üöÄ Deploy Container to Production'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webAppContainer'
                    appName: '$(frontendAppServiceProduction)'
                    imageName: '$(acrLoginServer)/$(frontendImageRepository):$(Build.BuildId)-prod'

                - script: |
                    echo "Production deployment completed!"
                    echo "Production URL: https://$(frontendAppServiceProduction).azurewebsites.net"
                  displayName: 'Deployment Summary'
